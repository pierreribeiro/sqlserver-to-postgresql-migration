;; PgBouncer Configuration for Perseus PostgreSQL Migration
;; Environment: Development
;; Version: 1.0
;; Last Updated: 2026-01-25
;;
;; Reference: specs/001-tsql-to-pgsql/spec.md CN-073
;; Pool size: 10, lifetime: 30 min (1800s), idle timeout: 5 min (300s)

;; ============================================================================
;; DATABASE DEFINITIONS
;; ============================================================================
[databases]

;; Primary development database
perseus_dev = host=postgres port=5432 dbname=perseus_dev pool_size=10 pool_mode=transaction

;; Test database (same physical database, different connection pool)
perseus_test = host=postgres port=5432 dbname=perseus_dev pool_size=5 pool_mode=transaction

;; Staging database placeholder (configure when staging environment is ready)
;; perseus_staging = host=postgres port=5432 dbname=perseus_staging pool_size=15 pool_mode=transaction

;; Admin database for PgBouncer statistics and control
pgbouncer = host=postgres port=5432 dbname=pgbouncer pool_size=2 pool_mode=statement

;; Fallback wildcard database (allows connections to any database)
;; * = host=postgres port=5432

;; ============================================================================
;; PGBOUNCER SETTINGS
;; ============================================================================
[pgbouncer]

;;;
;;; Administrative settings
;;;

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Where to wait for clients
;;;

;; IP address or * which means all IPs
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket is also used for local connections
;unix_socket_dir = /var/run/postgresql
;unix_socket_mode = 0777
;unix_socket_group =

;;;
;;; TLS settings for clients and backends
;;;

;; TLS configuration (disabled for development, enable for production)
;client_tls_sslmode = prefer
;client_tls_ca_file = /etc/pgbouncer/ca.crt
;client_tls_cert_file = /etc/pgbouncer/server.crt
;client_tls_key_file = /etc/pgbouncer/server.key
;server_tls_sslmode = prefer

;;;
;;; Authentication settings
;;;

;; Authentication type: md5, scram-sha-256, plain, trust, or pam
;; Using scram-sha-256 for enhanced security (PostgreSQL 17 default)
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

;; Query to use to fetch password from database
;; Useful when users are managed in PostgreSQL directly
;auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

;;;
;;; Users allowed into database 'pgbouncer'
;;;

;; Comma-separated list of users allowed to use SHOW, RELOAD, etc commands
admin_users = perseus_admin

;; Comma-separated list of users allowed to use only SHOW commands
stats_users = perseus_admin, stats_user

;;;
;;; Pooler personality questions
;;;

;; Pool mode: session, transaction, or statement
;; - session: server connection assigned for client's whole session
;; - transaction: server connection assigned for single transaction
;; - statement: server connection assigned for single statement
;; Using transaction mode for optimal connection reuse
pool_mode = transaction

;; Server is released back to pool after transaction finishes
server_reset_query = DISCARD ALL

;; Server is released back after query finishes (for statement pooling)
;server_reset_query_always = 0

;; Whether server_reset_query should run in all pooling modes
;ignore_startup_parameters = extra_float_digits

;; List of parameters that are not allowed to change between different users
;application_name_add_host = 0

;;;
;;; Connection limits
;;;

;; Total number of clients that can connect
max_client_conn = 1000

;; Default pool size per user/database pair
default_pool_size = 25

;; Minimum pool size - keep warm connections ready
min_pool_size = 10

;; How many additional connections to allow in case of emergency
reserve_pool_size = 5

;; If a client waits this long, use reserve pool
reserve_pool_timeout = 3

;; Maximum number of server connections per database
;; Should align with PostgreSQL max_connections setting (100)
max_db_connections = 100

;; Maximum number of server connections per user
max_user_connections = 100

;; If login fails due to max_db_connections, pool waits this many seconds
;server_login_retry = 15

;;;
;;; Connection lifetime and timeouts
;;;

;; Close server connection if it has been connected longer (seconds)
;; Set to 1800s (30 minutes) per CN-073 specification
server_lifetime = 1800

;; Close server connection if it has been idle more than this (seconds)
;; Set to 300s (5 minutes) per CN-073 specification
server_idle_timeout = 300

;; If server connection has been connected longer, try to close it (seconds)
;; Useful for gradual rebalancing
server_check_delay = 30

;; How long to wait for server connection (seconds)
server_connect_timeout = 15

;; Retry connecting to server after failure (seconds)
server_login_retry = 15

;; If client has been in "idle in transaction" state longer, it will be disconnected
;; 0 = disabled
query_timeout = 0

;; If client has not been serviced in this time, kill the client (seconds)
;; Used to prevent clients monopolizing connections
query_wait_timeout = 120

;; Maximum time to wait for canceling query (seconds)
cancel_wait_timeout = 10

;; If client has been idle more than this many seconds, close the connection
;; 0 = disabled (useful for development)
client_idle_timeout = 0

;; Maximum time for client login (seconds)
client_login_timeout = 60

;; Close automatically created (via "*") database pools if unused this long (seconds)
autodb_idle_timeout = 3600

;; Timeout for database response during startup (seconds)
;server_fast_close = 0

;;;
;;; Dangerous timeouts
;;;

;; Dangerous: if server does not answer in this time, assume it is broken and drop connection
;; Should be large if query_timeout is enabled
;server_round_robin = 0

;;;
;;; Low-level network settings
;;;

;; Buffer size for network send/receive
;pkt_buf = 4096

;; Maximum size of PostgreSQL startup packet
;sbuf_loopcnt = 5

;; Increase if seeing "suspend in connect: PgBouncer cannot connect to server"
;max_packet_size = 2147483647

;; TCP socket options
;tcp_defer_accept = 0
;tcp_socket_buffer = 0
;tcp_keepalive = 1
;tcp_keepcnt = 0
;tcp_keepidle = 0
;tcp_keepintvl = 0
;tcp_user_timeout = 0

;;;
;;; Logging
;;;

;; Syslog settings
;syslog = 0
;syslog_ident = pgbouncer
;syslog_facility = daemon

;; Log level: debug, info, warning, error
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1

;; Period for writing aggregated stats to log (seconds)
stats_period = 60

;; Logging verbosity: 0 = quiet, 1 = normal, 2 = verbose
verbose = 0

;;;
;;; Console access control
;;;

;; Comma-separated list of users who are allowed to change settings
admin_users = perseus_admin

;; Comma-separated list of users who can use SHOW commands (read-only)
stats_users = perseus_admin

;;;
;;; Connection sanity checks, timeouts
;;;

;; Check if server connection is working before returning it to pool
;server_check_query = select 1

;; Validate server certificates
;server_tls_protocols = secure

;;;
;;; Dangerous options - use with caution
;;;

;; Disable in production environments
;disable_pqexec = 0

;; Application name to set in connections
;application_name_add_host = 1

;; Track extra parameters
;track_extra_parameters = IntervalStyle

;; Enable prepared statements
;max_prepared_statements = 0
