#!/bin/bash
# Pre-commit hook for local validation
# Perseus Database Migration - SQL Server → PostgreSQL 17
#
# Installation:
#   cp .github/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Bypass (emergency only):
#   git commit --no-verify

set -e

echo "=================================================="
echo "Perseus Migration - Pre-commit Validation"
echo "=================================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for SQL files in commit
SQL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sql$' || true)

if [ -z "$SQL_FILES" ]; then
    echo -e "${GREEN}✓${NC} No SQL files in commit - skipping validation"
    exit 0
fi

echo -e "${YELLOW}→${NC} Found SQL files to validate:"
echo "$SQL_FILES" | while read -r file; do
    echo "  - $file"
done
echo ""

# Counter for validation results
TOTAL_FILES=0
PASSED_FILES=0
FAILED_FILES=0

# Validate each SQL file
echo "Running syntax validation..."
echo ""

for file in $SQL_FILES; do
    if [ ! -f "$file" ]; then
        echo -e "${YELLOW}⚠${NC} SKIP: $file (file not found)"
        continue
    fi

    TOTAL_FILES=$((TOTAL_FILES + 1))
    echo -e "${YELLOW}→${NC} Validating: $file"

    # Run syntax check
    if ./scripts/validation/syntax-check.sh "$file" > /dev/null 2>&1; then
        echo -e "${GREEN}  ✓ Syntax valid${NC}"
        PASSED_FILES=$((PASSED_FILES + 1))
    else
        echo -e "${RED}  ✗ Syntax error${NC}"
        FAILED_FILES=$((FAILED_FILES + 1))

        # Show detailed error
        echo -e "${RED}  Error details:${NC}"
        ./scripts/validation/syntax-check.sh "$file" 2>&1 | tail -10 | sed 's/^/    /'
    fi

    # Quality check for refactored files
    if [[ "$file" == *"source/building/pgsql/refactored"* ]]; then
        OBJECT_TYPE=$(echo $file | awk -F'/' '{print $(NF-1)}' | sed 's/[0-9]*\. create-//' | sed 's/ //g')
        OBJECT_NAME=$(basename $file .sql)

        # Run quality analysis (non-blocking)
        SCORE=$(python3 scripts/automation/analyze-object.py --type "$OBJECT_TYPE" --name "$OBJECT_NAME" --score-only 2>&1 | grep -oE '[0-9]+(\.[0-9]+)?' | head -1 || echo "N/A")

        if [ "$SCORE" != "N/A" ]; then
            if (( $(echo "$SCORE >= 7.0" | bc -l 2>/dev/null || echo "1") )); then
                echo -e "${GREEN}  ✓ Quality score: $SCORE/10.0${NC}"
            else
                echo -e "${YELLOW}  ⚠ Quality score: $SCORE/10.0 (below 7.0 threshold)${NC}"
            fi
        fi
    fi

    echo ""
done

# Summary
echo "=================================================="
echo "Validation Summary"
echo "=================================================="
echo -e "Total files:  $TOTAL_FILES"
echo -e "${GREEN}Passed:${NC}       $PASSED_FILES"
echo -e "${RED}Failed:${NC}       $FAILED_FILES"
echo ""

if [ $FAILED_FILES -gt 0 ]; then
    echo -e "${RED}✗ PRE-COMMIT VALIDATION FAILED${NC}"
    echo ""
    echo "Fix syntax errors before committing."
    echo "To bypass this check (emergency only):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ PRE-COMMIT VALIDATION PASSED${NC}"
echo ""
exit 0
